name: Build Osteoin App (Intel Path Fix)

on:
  push:
    branches: [ "main" ]

jobs:
  build-mac:
    # 최신 맥 러너 사용
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # [핵심] 인텔 파이썬이 길을 잃지 않도록 '가짜 주소(Symlink)'를 만들어줍니다.
    - name: Fix Library Path for Intel Python
      run: |
        # 1. gettext 설치
        brew install gettext
        
        # 2. 인텔 파이썬이 찾는 폴더(/usr/local/opt)가 없으면 만듭니다.
        sudo mkdir -p /usr/local/opt
        
        # 3. 실제 설치된 위치(/opt/homebrew...)를 인텔 파이썬이 찾는 위치(/usr/local...)로 연결합니다.
        # 이렇게 하면 파이썬은 자기가 원하는 곳에 파일이 있다고 착각하고 실행됩니다.
        sudo ln -s /opt/homebrew/opt/gettext /usr/local/opt/gettext
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        # 이제 경로 문제가 해결되었으므로 x64 파이썬이 정상 작동합니다.
        architecture: 'x64'
        
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        # 구형 맥 호환성을 위해 버전 고정
        pip install "pyinstaller<6.0.0" "PyQt5==5.15.9" opencv-python-headless numpy pymupdf pillow
        
    - name: Build Osteoin App
      run: |
        export MACOSX_DEPLOYMENT_TARGET=10.13
        
        if [ -f "osteoin.py" ]; then
          SCRIPT="osteoin.py"
        elif [ -f "Osteoin.py" ]; then
          SCRIPT="Osteoin.py"
        else
          echo "ERROR: osteoin.py 파일을 찾을 수 없습니다."
          ls -R
          exit 1
        fi
        
        # 인텔 환경에서 빌드하므로 결과물은 Intel Mac(10.13) 호환 앱이 됩니다.
        pyinstaller --noconsole --onefile --windowed --name "Osteoin" "$SCRIPT"
        
    - name: Zip the App
      run: |
        cd dist
        zip -r Osteoin_Mac_Intel.zip Osteoin.app
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Osteoin-App-Download
        path: dist/Osteoin_Mac_Intel.zip
