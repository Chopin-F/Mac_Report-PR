name: Build Osteoin App (Intel Rescue v2)

on:
  push:
    branches: [ "main" ]

jobs:
  build-mac:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Intel Homebrew & Dependencies
      run: |
        # 1. 홈브루가 설치될 메인 폴더 생성
        sudo mkdir -p /usr/local/Homebrew
        
        # 2. 필수 하위 폴더들 미리 생성 (에러 방지용)
        # Cellar, Caskroom, Frameworks 등을 미리 만들어 권한 문제를 예방합니다.
        sudo mkdir -p /usr/local/bin /usr/local/etc /usr/local/include /usr/local/lib \
                      /usr/local/sbin /usr/local/share /usr/local/var /usr/local/opt \
                      /usr/local/share/zsh /usr/local/share/zsh/site-functions \
                      /usr/local/Cellar /usr/local/Caskroom /usr/local/Frameworks

        # 3. 폴더 소유권 변경 (현재 사용자로)
        sudo chown -R $(whoami) /usr/local/*

        # 4. 홈브루 다운로드 (Git Clone)
        # --depth=1 옵션으로 최신만 받아서 속도를 높입니다.
        git clone --depth=1 https://github.com/Homebrew/brew /usr/local/Homebrew
        
        # 5. brew 명령어 심볼릭 링크 생성
        ln -s /usr/local/Homebrew/bin/brew /usr/local/bin/brew
        
        # 6. 인텔 모드로 gettext 설치 (시간 절약을 위해 업데이트 과정 생략)
        export HOMEBREW_NO_AUTO_UPDATE=1
        arch -x86_64 /usr/local/bin/brew install gettext
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        architecture: 'x64' # 인텔 파이썬
        
    - name: Install Dependencies
      run: |
        pip install --upgrade pip
        # 구형 맥 호환 라이브러리 설치
        pip install "pyinstaller<6.0.0" "PyQt5==5.15.9" opencv-python-headless numpy pymupdf pillow
        
    - name: Build Osteoin App
      run: |
        export MACOSX_DEPLOYMENT_TARGET=10.13
        
        if [ -f "osteoin.py" ]; then
          SCRIPT="osteoin.py"
        elif [ -f "Osteoin.py" ]; then
          SCRIPT="Osteoin.py"
        else
          echo "ERROR: osteoin.py 파일을 찾을 수 없습니다."
          ls -R
          exit 1
        fi
        
        pyinstaller --noconsole --onefile --windowed --name "Osteoin" "$SCRIPT"
        
    - name: Zip the App
      run: |
        cd dist
        zip -r Osteoin_Mac_Intel.zip Osteoin.app
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Osteoin-App-Download
        path: dist/Osteoin_Mac_Intel.zip
